<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PAI Services Gateway</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    h1 { font-size: 24px; font-weight: 600; }
    .status { display: flex; align-items: center; gap: 8px; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--green);
    }
    .status-dot.error { background: var(--red); }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .tab:hover { border-color: var(--accent); }
    .tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .panel { display: none; }
    .panel.active { display: block; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--accent);
    }
    .card h3 {
      font-size: 14px;
      color: var(--text-muted);
      margin: 16px 0 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--text-muted); font-weight: 500; }
    .positive { color: var(--green); }
    .negative { color: var(--red); }
    .neutral { color: var(--text-muted); }
    .signal-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .signal-badge.bull { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .signal-badge.bear { background: rgba(248, 81, 73, 0.2); color: var(--red); }
    .signal-badge.neutral { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }
    .focus-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .focus-item:last-child { border-bottom: none; }
    .capture-form {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .capture-form input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }
    .capture-form input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .capture-form button {
      padding: 12px 24px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .capture-form button:hover { opacity: 0.9; }
    .capture-item {
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .capture-item .time {
      font-size: 12px;
      color: var(--text-muted);
    }
    .capture-item .tags {
      margin-top: 6px;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      background: var(--border);
      border-radius: 4px;
      font-size: 11px;
      margin-right: 4px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: var(--bg);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .tools-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tool-chip {
      padding: 6px 12px;
      background: var(--bg);
      border-radius: 16px;
      font-size: 13px;
    }
    .tool-chip .count {
      color: var(--accent);
      font-weight: 600;
    }
    .refresh-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 13px;
    }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    .error-msg {
      padding: 16px;
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
    }
    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .service-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: border-color 0.2s;
    }
    .service-card:hover { border-color: var(--accent); }
    .service-card h3 {
      font-size: 18px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .service-card .desc {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 12px;
    }
    .service-card .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .service-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .service-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .service-status .dot.online { background: var(--green); }
    .service-status .dot.offline { background: var(--red); }
    .service-link {
      padding: 6px 12px;
      background: var(--accent);
      color: #fff;
      text-decoration: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }
    .service-link:hover { opacity: 0.9; }
    .news-item {
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .news-item h4 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .news-item h4 a {
      color: var(--text);
      text-decoration: none;
    }
    .news-item h4 a:hover { color: var(--accent); }
    .news-item .meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    .trend-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .trend-item:last-child { border-bottom: none; }
    .trend-name { font-weight: 500; }
    .trend-count { color: var(--accent); }
    @media (max-width: 600px) {
      .tabs { flex-wrap: wrap; }
      .capture-form { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>
    <h1>PAI Services Gateway</h1>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
      <button class="refresh-btn" onclick="refreshAll()">Refresh</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-panel="services">Services</div>
    <div class="tab" data-panel="brief">Morning Brief</div>
    <div class="tab" data-panel="news">News</div>
    <div class="tab" data-panel="trends">Trends</div>
    <div class="tab" data-panel="capture">Capture</div>
  </div>

  <!-- Services Panel -->
  <div class="panel active" id="services">
    <div class="services-grid" id="servicesGrid"></div>
  </div>

  <!-- Morning Brief Panel -->
  <div class="panel" id="brief">
    <div class="card">
      <h2 id="briefDate">Loading...</h2>
      <h3>Market Snapshot</h3>
      <table id="marketTable">
        <thead><tr><th>Asset</th><th>Price</th><th>24h</th><th>Signal</th><th>Score</th></tr></thead>
        <tbody></tbody>
      </table>
      <h3>Active Signals</h3>
      <div id="signalsList"></div>
      <h3>Today's Focus</h3>
      <div id="focusList"></div>
    </div>
  </div>

  <!-- News Panel -->
  <div class="panel" id="news">
    <div class="card">
      <h2>Latest News</h2>
      <div class="tabs" style="margin-bottom:16px">
        <div class="tab active" onclick="loadNews('all')">All</div>
        <div class="tab" onclick="loadNews('tech')">Tech</div>
        <div class="tab" onclick="loadNews('crypto')">Crypto</div>
        <div class="tab" onclick="loadNews('world')">World</div>
      </div>
      <div id="newsList"><div class="loading">Loading news...</div></div>
    </div>
  </div>

  <!-- Trends Panel -->
  <div class="panel" id="trends">
    <div class="card">
      <h2>Trending Now</h2>
      <div id="trendsList"><div class="loading">Loading trends...</div></div>
    </div>
  </div>

  <!-- Quick Capture Panel -->
  <div class="panel" id="capture">
    <div class="card">
      <h2>Quick Capture</h2>
      <form class="capture-form" onsubmit="submitCapture(event)">
        <input type="text" id="captureInput" placeholder="Capture an insight..." required>
        <input type="text" id="tagsInput" placeholder="Tags (comma-separated)">
        <button type="submit">Capture</button>
      </form>
      <div id="captureStatus"></div>
      <h3>Recent Captures</h3>
      <div id="capturesList"></div>
    </div>
  </div>

  <script>
    const API = '';
    const HOST = window.location.hostname;

    const SERVICES = [
      { name: 'IchimokuRadar', icon: 'ðŸ“Š', port: 5181, desc: 'Ichimoku trading signals for crypto & stocks', endpoint: '/api/health' },
      { name: 'TrendRadar', icon: 'ðŸ“ˆ', port: 5180, desc: 'Real-time social media trend tracking', endpoint: '/api/health' },
      { name: 'NewsScanner', icon: 'ðŸ“°', port: 5182, desc: 'RSS news aggregation (Tech, Crypto, World)', endpoint: '/api/health' },
      { name: 'PAI Gateway', icon: 'ðŸš€', port: 4001, desc: 'Morning brief, daily review, quick capture', endpoint: '/api/health' },
    ];

    // Tab switching
    document.querySelectorAll('.tab[data-panel]').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab[data-panel]').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.panel).classList.add('active');
      });
    });

    // Check service health
    async function checkService(service) {
      try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 3000);
        const res = await fetch(`http://${HOST}:${service.port}${service.endpoint}`, { signal: controller.signal });
        return res.ok;
      } catch { return false; }
    }

    // Load services
    async function loadServices() {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = SERVICES.map(s => `
        <div class="service-card" id="service-${s.port}">
          <h3>${s.icon} ${s.name}</h3>
          <div class="desc">${s.desc}</div>
          <div class="status-row">
            <div class="service-status">
              <div class="dot" id="dot-${s.port}"></div>
              <span id="status-${s.port}">Checking...</span>
            </div>
            <a href="http://${HOST}:${s.port}" target="_blank" class="service-link">Open</a>
          </div>
        </div>
      `).join('');

      // Check each service
      for (const s of SERVICES) {
        const online = await checkService(s);
        document.getElementById(`dot-${s.port}`).classList.toggle('online', online);
        document.getElementById(`dot-${s.port}`).classList.toggle('offline', !online);
        document.getElementById(`status-${s.port}`).textContent = online ? 'Online' : 'Offline';
      }
    }

    // Check gateway health
    async function checkHealth() {
      try {
        const res = await fetch(`${API}/api/health`);
        const data = await res.json();
        document.getElementById('statusDot').classList.remove('error');
        document.getElementById('statusText').textContent = `v${data.version} | ${data.jobs.length} jobs`;
        return true;
      } catch (e) {
        document.getElementById('statusDot').classList.add('error');
        document.getElementById('statusText').textContent = 'Disconnected';
        return false;
      }
    }

    // Load morning brief
    async function loadBrief() {
      try {
        const res = await fetch(`${API}/api/brief`);
        const data = await res.json();
        document.getElementById('briefDate').textContent = data.date || 'Morning Brief';
        const tbody = document.querySelector('#marketTable tbody');
        tbody.innerHTML = (data.sections?.market_snapshot?.assets || []).map(a => `
          <tr>
            <td><strong>${a.symbol}</strong></td>
            <td>${a.price}</td>
            <td class="${parseFloat(a.change) >= 0 ? 'positive' : 'negative'}">${a.change}</td>
            <td>${a.signal ? `<span class="signal-badge ${getSignalClass(a.score)}">${a.signal}</span>` : 'â€”'}</td>
            <td class="${a.score > 0 ? 'positive' : a.score < 0 ? 'negative' : 'neutral'}">${a.score !== undefined ? (a.score > 0 ? '+' : '') + a.score : 'â€”'}</td>
          </tr>
        `).join('');
        document.getElementById('signalsList').innerHTML = (data.sections?.active_signals || []).length
          ? data.sections.active_signals.map(s => `
            <div class="focus-item">
              <strong>${s.asset}</strong> (${s.timeframe}):
              <span class="signal-badge ${getSignalClass(s.score)}">${s.label}</span>
              <span class="${s.score > 0 ? 'positive' : 'negative'}">(${s.score > 0 ? '+' : ''}${s.score})</span>
              â€” ${s.details}
            </div>
          `).join('')
          : '<p class="neutral">No significant signals</p>';
        document.getElementById('focusList').innerHTML = (data.sections?.todays_focus || []).map(f => `
          <div class="focus-item">${f}</div>
        `).join('');
      } catch (e) {
        document.getElementById('briefDate').textContent = 'Error loading brief';
      }
    }

    // Load news from NewsScanner
    async function loadNews(topic = 'all') {
      try {
        const url = topic === 'all'
          ? `http://${HOST}:5182/api/news`
          : `http://${HOST}:5182/api/news/${topic}`;
        const res = await fetch(url);
        const data = await res.json();
        document.getElementById('newsList').innerHTML = (data.items || []).slice(0, 15).map(item => `
          <div class="news-item">
            <h4><a href="${item.link}" target="_blank">${item.title}</a></h4>
            <div class="meta">${item.source} Â· ${item.topic} Â· ${new Date(item.date).toLocaleDateString()}</div>
          </div>
        `).join('') || '<p class="neutral">No news available</p>';
      } catch (e) {
        document.getElementById('newsList').innerHTML = '<p class="error-msg">NewsScanner offline. <a href="http://' + HOST + ':5182" target="_blank">Check service</a></p>';
      }
    }

    // Load trends from TrendRadar
    async function loadTrends() {
      try {
        const res = await fetch(`http://${HOST}:5180/api/topics`);
        const data = await res.json();
        const trends = data.topics || [];
        document.getElementById('trendsList').innerHTML = trends.length
          ? trends.slice(0, 20).map(t => `
            <div class="trend-item">
              <span class="trend-name">${t.name || t.topic}</span>
              <span class="trend-count">${t.mentionCount || t.count || ''} mentions</span>
            </div>
          `).join('')
          : '<p class="neutral">No trends available</p>';
      } catch (e) {
        document.getElementById('trendsList').innerHTML = '<p class="error-msg">TrendRadar offline. <a href="http://' + HOST + ':5180" target="_blank">Check service</a></p>';
      }
    }

    // Load captures
    async function loadCaptures() {
      try {
        const res = await fetch(`${API}/api/capture/recent?limit=10`);
        const data = await res.json();
        document.getElementById('capturesList').innerHTML = (data.captures || []).length
          ? data.captures.map(c => `
            <div class="capture-item">
              <div>${c.insight}</div>
              <div class="time">${new Date(c.timestamp).toLocaleString()}</div>
              ${c.tags?.length ? `<div class="tags">${c.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
            </div>
          `).join('')
          : '<p class="neutral">No captures yet</p>';
      } catch (e) {
        document.getElementById('capturesList').innerHTML = '<p class="error-msg">Error loading captures</p>';
      }
    }

    // Submit capture
    async function submitCapture(e) {
      e.preventDefault();
      const insight = document.getElementById('captureInput').value;
      const tagsRaw = document.getElementById('tagsInput').value;
      const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
      try {
        const res = await fetch(`${API}/api/capture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ insight, tags })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('captureInput').value = '';
          document.getElementById('tagsInput').value = '';
          document.getElementById('captureStatus').innerHTML = '<p class="positive">Captured!</p>';
          setTimeout(() => document.getElementById('captureStatus').innerHTML = '', 2000);
          loadCaptures();
        }
      } catch (e) {
        document.getElementById('captureStatus').innerHTML = '<p class="error-msg">Error capturing</p>';
      }
    }

    function getSignalClass(score) {
      if (score >= 20) return 'bull';
      if (score <= -20) return 'bear';
      return 'neutral';
    }

    async function refreshAll() {
      await Promise.all([
        checkHealth(),
        loadServices(),
        loadBrief(),
        loadNews(),
        loadTrends(),
        loadCaptures()
      ]);
    }

    // Initial load
    refreshAll();
    setInterval(refreshAll, 5 * 60 * 1000);
  </script>
</body>
</html>
