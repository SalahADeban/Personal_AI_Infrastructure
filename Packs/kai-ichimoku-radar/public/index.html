<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IchimokuRadar - Signal Intelligence</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e2e8f0;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0a0a0f 100%);
      border-bottom: 1px solid #2a2a3e;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo-icon { font-size: 2rem; }
    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .logo-version { font-size: 0.7rem; color: #64748b; margin-left: 0.5rem; }
    .header-meta { display: flex; align-items: center; gap: 1rem; color: #94a3b8; font-size: 0.875rem; }
    .refresh-btn {
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      color: white; border: none; padding: 0.5rem 1rem;
      border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;
    }
    .refresh-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.3); }
    .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #151520 100%);
      border: 1px solid #2a2a3e;
      border-radius: 0.75rem;
      padding: 1rem;
    }
    .stat-label { color: #64748b; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; }
    .stat-value {
      font-size: 1.75rem; font-weight: 700; margin-top: 0.25rem;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .tf-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .tf-tab {
      background: #1a1a2e; border: 1px solid #2a2a3e; color: #94a3b8;
      padding: 0.5rem 1.25rem; border-radius: 2rem; cursor: pointer;
      font-size: 0.85rem; transition: all 0.2s;
    }
    .tf-tab:hover { border-color: #f59e0b; color: #e2e8f0; }
    .tf-tab.active { background: linear-gradient(135deg, #f59e0b, #ef4444); border-color: transparent; color: white; }

    .signals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 1rem;
    }

    .signal-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #151520 100%);
      border: 1px solid #2a2a3e;
      border-radius: 0.75rem;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .signal-card:hover { border-color: #f59e0b; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .signal-card.bullish { border-left: 3px solid #22c55e; }
    .signal-card.bearish { border-left: 3px solid #ef4444; }
    .signal-card.neutral { border-left: 3px solid #64748b; }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .card-asset { font-size: 1.25rem; font-weight: 700; }
    .card-price { font-size: 1rem; color: #94a3b8; }
    .card-tf { font-size: 0.65rem; padding: 0.15rem 0.5rem; border-radius: 1rem; background: #2a2a3e; color: #94a3b8; margin-left: 0.5rem; }

    .signal-label {
      display: inline-block;
      font-size: 0.75rem; font-weight: 700;
      padding: 0.25rem 0.75rem; border-radius: 1rem;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .label-STRONG_BULL { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .label-BULLISH { background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
    .label-NEUTRAL { background: rgba(100,116,139,0.2); color: #94a3b8; border: 1px solid rgba(100,116,139,0.3); }
    .label-BEARISH { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
    .label-STRONG_BEAR { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    .score-gauge { margin: 0.75rem 0; }
    .score-track {
      width: 100%; height: 8px; background: #2a2a3e; border-radius: 4px; position: relative; overflow: visible;
    }
    .score-fill {
      height: 100%; border-radius: 4px; transition: width 0.5s;
      position: absolute; top: 0;
    }
    .score-fill.positive { background: linear-gradient(90deg, #64748b, #22c55e); left: 50%; }
    .score-fill.negative { background: linear-gradient(90deg, #ef4444, #64748b); right: 50%; }
    .score-center {
      position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
      width: 2px; height: 12px; background: #64748b;
    }
    .score-value {
      text-align: center; font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;
    }

    .component-bars { margin: 0.75rem 0; }
    .comp-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; font-size: 0.7rem; }
    .comp-label { width: 80px; color: #64748b; text-align: right; }
    .comp-bar-track { flex: 1; height: 4px; background: #2a2a3e; border-radius: 2px; position: relative; }
    .comp-bar-fill { height: 100%; border-radius: 2px; position: absolute; top: 0; }
    .comp-bar-fill.pos { background: #22c55e; left: 50%; }
    .comp-bar-fill.neg { background: #ef4444; right: 50%; }
    .comp-val { width: 30px; font-size: 0.65rem; color: #64748b; }

    .edge-to-edge {
      margin-top: 0.5rem; padding: 0.5rem 0.75rem;
      border-radius: 0.5rem; font-size: 0.75rem;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #f59e0b;
    }

    .trigger-list { margin-top: 0.5rem; }
    .trigger-item {
      font-size: 0.7rem; color: #94a3b8; padding: 0.2rem 0;
      display: flex; align-items: center; gap: 0.3rem;
    }
    .trigger-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .trigger-dot.bullish { background: #22c55e; }
    .trigger-dot.bearish { background: #ef4444; }

    .cloud-mini { margin: 0.5rem 0; }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 2rem;
    }
    .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal-content {
      background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 1rem;
      max-width: 750px; width: 100%; padding: 1.5rem;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .modal-close { background: none; border: none; color: #64748b; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
    .modal-close:hover { color: #e2e8f0; }

    .modal-section { margin-bottom: 1.25rem; }
    .modal-section-title { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }

    .modal-comp-table { width: 100%; }
    .modal-comp-table td { padding: 0.3rem 0; font-size: 0.8rem; }
    .modal-comp-table .comp-name { color: #94a3b8; }
    .modal-comp-table .comp-max { color: #64748b; font-size: 0.7rem; }

    .chart-container { background: rgba(15,15,25,0.8); border: 1px solid #2a2a3e; border-radius: 0.75rem; padding: 1rem; }
    .chart-legend { display: flex; gap: 1rem; font-size: 0.65rem; color: #64748b; margin-bottom: 0.5rem; flex-wrap: wrap; }
    .chart-legend span { display: flex; align-items: center; gap: 0.3rem; }

    .history-point { padding: 0.3rem 0; border-bottom: 1px solid #1a1a2e; font-size: 0.75rem; display: flex; justify-content: space-between; }

    .loading { text-align: center; padding: 4rem; color: #64748b; }
    .loading-spinner {
      width: 48px; height: 48px; border: 3px solid #2a2a3e; border-top-color: #f59e0b;
      border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 1rem; }
      .signals-grid { grid-template-columns: 1fr; }
      .stats-bar { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <span class="logo-icon">ðŸ“Š</span>
      <span class="logo-text">IchimokuRadar</span>
      <span class="logo-version">v1.0</span>
    </div>
    <div class="header-meta">
      <span id="lastUpdate">Loading...</span>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">Refresh</button>
    </div>
  </header>

  <div class="container">
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Assets Tracked</div>
        <div class="stat-value" id="assetCount">-</div>
      </div>
      <div class="stat-card" style="border-color: #22c55e;">
        <div class="stat-label" style="color: #22c55e;">Bullish Signals</div>
        <div class="stat-value" id="bullCount" style="background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text;">-</div>
      </div>
      <div class="stat-card" style="border-color: #ef4444;">
        <div class="stat-label" style="color: #ef4444;">Bearish Signals</div>
        <div class="stat-value" id="bearCount" style="background: linear-gradient(135deg, #ef4444, #dc2626); -webkit-background-clip: text;">-</div>
      </div>
      <div class="stat-card" style="border-color: #f59e0b;">
        <div class="stat-label" style="color: #f59e0b;">Edge-to-Edge Active</div>
        <div class="stat-value" id="e2eCount" style="background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text;">-</div>
      </div>
    </div>

    <div class="tf-tabs" id="tfTabs"></div>

    <div id="signalsContainer" class="signals-grid">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Calculating Ichimoku signals...</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Asset</h2>
          <p id="modalMeta" style="color: #64748b; font-size: 0.9rem;"></p>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    let allSignals = [];
    let activeTimeframe = 'all';

    function formatPrice(p) {
      if (p >= 1000) return '$' + p.toLocaleString(undefined, { maximumFractionDigits: 0 });
      if (p >= 1) return '$' + p.toFixed(2);
      return '$' + p.toFixed(4);
    }

    function formatTime(dateStr) {
      const d = new Date(dateStr);
      const now = new Date();
      const diff = (now - d) / 1000 / 60;
      if (diff < 60) return `${Math.round(diff)}m ago`;
      if (diff < 1440) return `${Math.round(diff / 60)}h ago`;
      return d.toLocaleDateString();
    }

    function scoreColor(score) {
      if (score >= 50) return '#22c55e';
      if (score > 15) return '#4ade80';
      if (score <= -50) return '#ef4444';
      if (score < -15) return '#f87171';
      return '#64748b';
    }

    function cardClass(label) {
      if (label === 'STRONG_BULL' || label === 'BULLISH') return 'bullish';
      if (label === 'STRONG_BEAR' || label === 'BEARISH') return 'bearish';
      return 'neutral';
    }

    function renderScoreGauge(score) {
      const pct = Math.abs(score) / 2; // max 50% width from center
      const cls = score >= 0 ? 'positive' : 'negative';
      const style = score >= 0
        ? `left: 50%; width: ${pct}%`
        : `right: 50%; width: ${pct}%`;
      return `
        <div class="score-gauge">
          <div class="score-track">
            <div class="score-center"></div>
            <div class="score-fill ${cls}" style="${style}"></div>
          </div>
          <div class="score-value">${score > 0 ? '+' : ''}${score}</div>
        </div>`;
    }

    function renderComponentBars(comp) {
      const items = [
        { label: 'Kumo Twist', val: comp.kumoTwist, max: 30 },
        { label: 'TK Cross', val: comp.tkCross, max: 25 },
        { label: 'Price/Cloud', val: comp.priceVsCloud, max: 20 },
        { label: 'Chikou', val: comp.chikouSpan, max: 15 },
        { label: 'Thickness', val: comp.cloudThickness, max: 10 },
      ];
      return `<div class="component-bars">${items.map(i => {
        const pct = Math.abs(i.val) / i.max * 50;
        const cls = i.val >= 0 ? 'pos' : 'neg';
        const style = i.val >= 0
          ? `left: 50%; width: ${pct}%`
          : `right: 50%; width: ${pct}%`;
        return `<div class="comp-row">
          <span class="comp-label">${i.label}</span>
          <div class="comp-bar-track">
            <div class="comp-bar-fill ${cls}" style="${style}"></div>
          </div>
          <span class="comp-val">${i.val > 0 ? '+' : ''}${i.val}</span>
        </div>`;
      }).join('')}</div>`;
    }

    function generateMiniCloud(ohlcv, ich) {
      if (!ohlcv || ohlcv.length < 10) return '';
      const w = 160, h = 40, pad = 2;
      const recent = ohlcv.slice(-30);
      const closes = recent.map(c => c.close);
      const allVals = [...closes, ich.cloudTop, ich.cloudBottom, ich.tenkanSen, ich.kijunSen];
      const max = Math.max(...allVals);
      const min = Math.min(...allVals);
      const range = max - min || 1;

      function y(v) { return pad + (h - 2 * pad) * (1 - (v - min) / range); }
      function x(i) { return (i / (recent.length - 1)) * w; }

      const priceLine = closes.map((v, i) => `${x(i)},${y(v)}`).join(' ');

      // Cloud area (simplified: just show current cloud level as horizontal band)
      const cloudTopY = y(ich.cloudTop);
      const cloudBotY = y(ich.cloudBottom);
      const cloudColor = ich.cloudColor === 'green' ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
      const cloudStroke = ich.cloudColor === 'green' ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)';

      return `<div class="cloud-mini">
        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
          <rect x="0" y="${cloudTopY}" width="${w}" height="${cloudBotY - cloudTopY}" fill="${cloudColor}" />
          <line x1="0" y1="${cloudTopY}" x2="${w}" y2="${cloudTopY}" stroke="${cloudStroke}" stroke-width="0.5"/>
          <line x1="0" y1="${cloudBotY}" x2="${w}" y2="${cloudBotY}" stroke="${cloudStroke}" stroke-width="0.5"/>
          <polyline points="${priceLine}" fill="none" stroke="#e2e8f0" stroke-width="1.5" stroke-linecap="round"/>
          <line x1="0" y1="${y(ich.tenkanSen)}" x2="${w}" y2="${y(ich.tenkanSen)}" stroke="#3b82f6" stroke-width="0.75" stroke-dasharray="2,2"/>
          <line x1="0" y1="${y(ich.kijunSen)}" x2="${w}" y2="${y(ich.kijunSen)}" stroke="#ef4444" stroke-width="0.75" stroke-dasharray="2,2"/>
        </svg>
      </div>`;
    }

    function renderSignals(signals) {
      const container = document.getElementById('signalsContainer');
      let filtered = activeTimeframe === 'all' ? signals : signals.filter(s => s.timeframe === activeTimeframe);

      if (!filtered.length) {
        container.innerHTML = '<div class="loading"><p>No signals available. Waiting for data...</p></div>';
        return;
      }

      container.innerHTML = filtered.map(sig => `
        <div class="signal-card ${cardClass(sig.label)}" onclick="showDetail('${sig.asset}', '${sig.timeframe}')">
          <div class="card-header">
            <div>
              <span class="card-asset">${sig.asset}</span>
              <span class="card-tf">${sig.timeframe}</span>
            </div>
            <span class="card-price">${formatPrice(sig.price)}</span>
          </div>

          <span class="signal-label label-${sig.label}">${sig.label.replace('_', ' ')}</span>

          ${renderScoreGauge(sig.score)}

          ${sig.ichimoku ? generateMiniCloud(null, sig.ichimoku) : ''}

          ${renderComponentBars(sig.components)}

          ${sig.edgeToEdge && sig.edgeToEdge.active ? `
            <div class="edge-to-edge">
              IN CLOUD &mdash; Edge-to-Edge ${sig.edgeToEdge.direction}
              | Target: ${formatPrice(sig.edgeToEdge.target)} (${sig.edgeToEdge.distancePercent > 0 ? '+' : ''}${sig.edgeToEdge.distancePercent}%)
            </div>
          ` : ''}

          ${sig.triggers.length > 0 ? `
            <div class="trigger-list">
              ${sig.triggers.map(t => `
                <div class="trigger-item">
                  <span class="trigger-dot ${t.direction}"></span>
                  ${t.description}
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderTabs() {
      const tabs = document.getElementById('tfTabs');
      const tfs = ['all', '1D', '1M'];
      tabs.innerHTML = tfs.map(tf => `
        <button class="tf-tab ${activeTimeframe === tf ? 'active' : ''}" onclick="setTimeframe('${tf}')">
          ${tf === 'all' ? 'All' : tf === '1D' ? 'Daily' : 'Monthly'}
          <span style="margin-left:0.3rem;opacity:0.7;font-size:0.75rem;">
            ${tf === 'all' ? allSignals.length : allSignals.filter(s => s.timeframe === tf).length}
          </span>
        </button>
      `).join('');
    }

    function setTimeframe(tf) {
      activeTimeframe = tf;
      renderTabs();
      renderSignals(allSignals);
    }

    function updateStats() {
      const uniqueAssets = new Set(allSignals.map(s => s.asset));
      document.getElementById('assetCount').textContent = uniqueAssets.size;
      document.getElementById('bullCount').textContent = allSignals.filter(s => s.label === 'BULLISH' || s.label === 'STRONG_BULL').length;
      document.getElementById('bearCount').textContent = allSignals.filter(s => s.label === 'BEARISH' || s.label === 'STRONG_BEAR').length;
      document.getElementById('e2eCount').textContent = allSignals.filter(s => s.edgeToEdge?.active).length;
    }

    function generateFullCloudChart(ohlcv, ich, w, h) {
      if (!ohlcv || ohlcv.length < 10) return '<div style="color:#64748b;text-align:center;padding:1rem;">Not enough data for chart</div>';
      const pad = { top: 10, right: 10, bottom: 5, left: 10 };
      const cw = w - pad.left - pad.right;
      const ch = h - pad.top - pad.bottom;

      const closes = ohlcv.map(c => c.close);
      const highs = ohlcv.map(c => c.high);
      const lows = ohlcv.map(c => c.low);
      const allVals = [...closes, ...highs, ...lows];
      if (ich) allVals.push(ich.cloudTop, ich.cloudBottom, ich.tenkanSen, ich.kijunSen);
      const max = Math.max(...allVals);
      const min = Math.min(...allVals);
      const range = max - min || 1;

      function yv(v) { return pad.top + ch * (1 - (v - min) / range); }
      function xv(i) { return pad.left + (i / (ohlcv.length - 1)) * cw; }

      const priceLine = closes.map((v, i) => `${xv(i)},${yv(v)}`).join(' ');

      // Cloud band
      let cloudSvg = '';
      if (ich) {
        const cTop = yv(ich.cloudTop);
        const cBot = yv(ich.cloudBottom);
        const fill = ich.cloudColor === 'green' ? 'rgba(34,197,94,0.12)' : 'rgba(239,68,68,0.12)';
        const stroke = ich.cloudColor === 'green' ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)';
        cloudSvg = `
          <rect x="${pad.left}" y="${cTop}" width="${cw}" height="${Math.max(cBot - cTop, 1)}" fill="${fill}" />
          <line x1="${pad.left}" y1="${cTop}" x2="${w - pad.right}" y2="${cTop}" stroke="${stroke}" stroke-width="0.75"/>
          <line x1="${pad.left}" y1="${cBot}" x2="${w - pad.right}" y2="${cBot}" stroke="${stroke}" stroke-width="0.75"/>
          <line x1="${pad.left}" y1="${yv(ich.tenkanSen)}" x2="${w - pad.right}" y2="${yv(ich.tenkanSen)}" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,3"/>
          <line x1="${pad.left}" y1="${yv(ich.kijunSen)}" x2="${w - pad.right}" y2="${yv(ich.kijunSen)}" stroke="#ef4444" stroke-width="1" stroke-dasharray="4,3"/>
        `;
      }

      // Grid lines
      const gridSvg = [0.25, 0.5, 0.75].map(p => {
        const gy = pad.top + ch * (1 - p);
        const val = min + range * p;
        return `<line x1="${pad.left}" y1="${gy}" x2="${w - pad.right}" y2="${gy}" stroke="#2a2a3e" stroke-width="0.5"/>`;
      }).join('');

      return `
        <div class="chart-container">
          <div class="chart-legend">
            <span><span style="display:inline-block;width:12px;height:2px;background:#e2e8f0;border-radius:1px;"></span> Price</span>
            <span><span style="display:inline-block;width:12px;height:2px;background:#3b82f6;border-radius:1px;"></span> Tenkan</span>
            <span><span style="display:inline-block;width:12px;height:2px;background:#ef4444;border-radius:1px;"></span> Kijun</span>
            <span><span style="display:inline-block;width:12px;height:6px;background:${ich?.cloudColor === 'green' ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)'};border-radius:1px;"></span> Cloud</span>
          </div>
          <svg width="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">
            ${gridSvg}
            ${cloudSvg}
            <polyline points="${priceLine}" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>`;
    }

    async function showDetail(asset, timeframe) {
      try {
        const res = await fetch(`/api/signals/${asset}/${timeframe}`);
        const data = await res.json();
        if (!data.signal) return;

        const sig = data.signal;
        document.getElementById('modalTitle').textContent = `${sig.asset} â€” ${sig.timeframe === '1D' ? 'Daily' : 'Monthly'}`;
        document.getElementById('modalMeta').innerHTML =
          `${formatPrice(sig.price)} | <span class="signal-label label-${sig.label}">${sig.label.replace('_', ' ')}</span> (Score: ${sig.score})`;

        let html = '';

        // Chart
        html += '<div class="modal-section">';
        html += '<div class="modal-section-title">Ichimoku Cloud Chart</div>';
        html += generateFullCloudChart(data.ohlcv, sig.ichimoku, 680, 220);
        html += '</div>';

        // Components
        html += '<div class="modal-section">';
        html += '<div class="modal-section-title">Signal Components</div>';
        html += `<table class="modal-comp-table">
          <tr><td class="comp-name">Kumo Twist</td><td style="color:${scoreColor(sig.components.kumoTwist)}">${sig.components.kumoTwist > 0 ? '+' : ''}${sig.components.kumoTwist}</td><td class="comp-max">/ Â±30</td></tr>
          <tr><td class="comp-name">TK Cross</td><td style="color:${scoreColor(sig.components.tkCross)}">${sig.components.tkCross > 0 ? '+' : ''}${sig.components.tkCross}</td><td class="comp-max">/ Â±25</td></tr>
          <tr><td class="comp-name">Price vs Cloud</td><td style="color:${scoreColor(sig.components.priceVsCloud)}">${sig.components.priceVsCloud > 0 ? '+' : ''}${sig.components.priceVsCloud}</td><td class="comp-max">/ Â±20</td></tr>
          <tr><td class="comp-name">Chikou Span</td><td style="color:${scoreColor(sig.components.chikouSpan)}">${sig.components.chikouSpan > 0 ? '+' : ''}${sig.components.chikouSpan}</td><td class="comp-max">/ Â±15</td></tr>
          <tr><td class="comp-name">Cloud Thickness</td><td style="color:${scoreColor(sig.components.cloudThickness)}">${sig.components.cloudThickness > 0 ? '+' : ''}${sig.components.cloudThickness}</td><td class="comp-max">/ Â±10</td></tr>
        </table>`;
        html += '</div>';

        // Ichimoku values
        if (sig.ichimoku) {
          html += '<div class="modal-section">';
          html += '<div class="modal-section-title">Ichimoku Values</div>';
          html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.25rem;font-size:0.8rem;">
            <div style="color:#64748b">Tenkan-sen: <span style="color:#3b82f6">${formatPrice(sig.ichimoku.tenkanSen)}</span></div>
            <div style="color:#64748b">Kijun-sen: <span style="color:#ef4444">${formatPrice(sig.ichimoku.kijunSen)}</span></div>
            <div style="color:#64748b">Cloud Top: <span style="color:#e2e8f0">${formatPrice(sig.ichimoku.cloudTop)}</span></div>
            <div style="color:#64748b">Cloud Bottom: <span style="color:#e2e8f0">${formatPrice(sig.ichimoku.cloudBottom)}</span></div>
            <div style="color:#64748b">Cloud Color: <span style="color:${sig.ichimoku.cloudColor === 'green' ? '#22c55e' : '#ef4444'}">${sig.ichimoku.cloudColor}</span></div>
            <div style="color:#64748b">Future Cloud: <span style="color:${sig.ichimoku.futureCloudColor === 'green' ? '#22c55e' : '#ef4444'}">${sig.ichimoku.futureCloudColor}</span></div>
          </div>`;
          html += '</div>';
        }

        // Edge-to-Edge
        if (sig.edgeToEdge?.active) {
          html += '<div class="modal-section">';
          html += '<div class="modal-section-title">Edge-to-Edge Trade</div>';
          html += `<div class="edge-to-edge">
            Direction: ${sig.edgeToEdge.direction} | Entry: ${formatPrice(sig.edgeToEdge.entry)} | Target: ${formatPrice(sig.edgeToEdge.target)} (${sig.edgeToEdge.distancePercent > 0 ? '+' : ''}${sig.edgeToEdge.distancePercent}%)
          </div>`;
          html += '</div>';
        }

        // Triggers
        if (sig.triggers.length) {
          html += '<div class="modal-section">';
          html += '<div class="modal-section-title">Active Triggers</div>';
          html += sig.triggers.map(t => `
            <div class="trigger-item"><span class="trigger-dot ${t.direction}"></span> ${t.description}</div>
          `).join('');
          html += '</div>';
        }

        // History
        if (data.history && data.history.length > 1) {
          html += '<div class="modal-section">';
          html += '<div class="modal-section-title">Signal History</div>';
          html += data.history.slice(-10).reverse().map(h => `
            <div class="history-point">
              <span>${formatTime(h.timestamp)}</span>
              <span class="signal-label label-${h.label}" style="font-size:0.6rem;padding:0.1rem 0.4rem;">${h.label.replace('_',' ')}</span>
              <span style="color:${scoreColor(h.score)}">${h.score > 0 ? '+' : ''}${h.score}</span>
              <span style="color:#64748b">${formatPrice(h.price)}</span>
            </div>
          `).join('');
          html += '</div>';
        }

        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('modalOverlay').classList.add('active');
      } catch (err) {
        console.error('Error loading detail:', err);
      }
    }

    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modalOverlay').classList.remove('active');
    }

    async function refreshData() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      await fetch('/api/refresh', { method: 'POST' });
      setTimeout(async () => {
        await loadData();
        btn.disabled = false;
        btn.textContent = 'Refresh';
      }, 10000);
    }

    async function loadData() {
      try {
        const res = await fetch('/api/signals');
        const data = await res.json();
        if (data) {
          allSignals = data.signals || [];
          updateStats();
          renderTabs();
          renderSignals(allSignals);
          if (data.lastRefresh) {
            document.getElementById('lastUpdate').textContent = `Updated ${formatTime(data.lastRefresh)}`;
          }
        }
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    loadData();
    setInterval(loadData, 2 * 60 * 1000);
  </script>
</body>
</html>
